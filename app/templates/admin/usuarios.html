{% extends "base.html" %}

{% block title %}Usuarios{% endblock %}
{% block header %}Gestión de Usuarios{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Formulario para añadir usuario -->
    <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md h-fit">
        <h3 class="text-xl font-semibold mb-4">Añadir Nuevo Usuario</h3>
        <form action="{{ url_for('admin.add_user') }}" method="POST">
            <div class="mb-4">
                <label for="username" class="block text-sm font-medium text-gray-700">Nombre de Usuario</label>
                <input type="text" name="username" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required>
            </div>
            <div class="mb-4">
                <label for="password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                <input type="password" name="password" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required>
            </div>
            <div class="mb-4">
                <label for="confirm_password" class="block text-sm font-medium text-gray-700">Confirmar Contraseña</label>
                <input type="password" name="confirm_password" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required>
            </div>
            <div class="mb-4">
                <label for="role" class="block text-sm font-medium text-gray-700">Rol</label>
                <select name="role" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                    <option value="operador">Operador</option>
                    <option value="admin">Administrador</option>
                </select>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Añadir Usuario</button>
        </form>
    </div>

    <!-- Tabla de usuarios -->
    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md overflow-x-auto">
        <table class="w-full whitespace-nowrap">
            <thead>
                <tr class="text-left font-bold">
                    <th class="pb-4 pt-6 px-6">ID</th>
                    <th class="pb-4 pt-6 px-6">Usuario</th>
                    <th class="pb-4 pt-6 px-6">Rol</th>
                    <th class="pb-4 pt-6 px-6">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr class="hover:bg-gray-100">
                    <td class="border-t py-4 px-6">{{ user.id }}</td>
                    <td class="border-t py-4 px-6 font-semibold">{{ user.username }}</td>
                    <td class="border-t py-4 px-6">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {{ 'bg-blue-100 text-blue-800' if user.role == 'admin' else 'bg-green-100 text-green-800' }}">
                            {{ user.role|capitalize }}
                        </span>
                    </td>
                    <td class="border-t py-4 px-6 flex items-center space-x-4">
                        <button onclick="openEditModal(this)"
                                data-id="{{ user.id }}"
                                data-username="{{ user.username }}"
                                data-role="{{ user.role }}"
                                class="text-indigo-600 hover:text-indigo-900 font-medium">Editar</button>
                        {% if user.id != current_user.id %}
                        <form action="{{ url_for('admin.delete_user', id=user.id) }}" method="POST" onsubmit="return confirm('¿Estás seguro de que quieres eliminar a este usuario?');">
                            <button type="submit" class="text-red-600 hover:text-red-900 font-medium">Eliminar</button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal de Edición -->
<div id="editUserModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center">
            <h3 class="text-2xl font-semibold">Editar Usuario</h3>
            <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
        </div>
        
        <!-- Formulario para editar datos -->
        <form id="editUserForm" method="POST" class="mt-4">
            <h4 class="font-semibold mb-2">Datos del Usuario</h4>
            <div class="mb-4">
                <label for="edit_username" class="block text-sm font-medium text-gray-700">Nombre de Usuario</label>
                <input type="text" id="edit_username" name="username" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required>
            </div>
            <div class="mb-4">
                <label for="edit_role" class="block text-sm font-medium text-gray-700">Rol</label>
                <select id="edit_role" name="role" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                    <option value="operador">Operador</option>
                    <option value="admin">Administrador</option>
                </select>
            </div>
            <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Guardar Cambios</button>
        </form>

        <hr class="my-6">

        <!-- Formulario para cambiar contraseña -->
        <form id="changePasswordForm" method="POST" class="mt-4">
             <h4 class="font-semibold mb-2">Cambiar Contraseña</h4>
            <div class="mb-4">
                <label for="new_password" class="block text-sm font-medium text-gray-700">Nueva Contraseña</label>
                <input type="password" id="new_password" name="new_password" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required>
            </div>
            <div class="mb-4">
                <label for="confirm_password_change" class="block text-sm font-medium text-gray-700">Confirmar Nueva Contraseña</label>
                <input type="password" id="confirm_password_change" name="confirm_password_change" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required>
            </div>
            <button type="submit" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">Cambiar Contraseña</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const modal = document.getElementById('editUserModal');
    const editForm = document.getElementById('editUserForm');
    const passwordForm = document.getElementById('changePasswordForm');
    
    function openEditModal(button) {
        const id = button.dataset.id;
        const username = button.dataset.username;
        const role = button.dataset.role;

        // Poblar el formulario de edición
        document.getElementById('edit_username').value = username;
        document.getElementById('edit_role').value = role;
        
        // Actualizar las URLs de acción de los formularios
        editForm.action = `/admin/usuario/edit/${id}`;
        passwordForm.action = `/admin/usuario/password/${id}`;
        
        modal.classList.remove('hidden');
    }

    function closeEditModal() {
        modal.classList.add('hidden');
    }

    // Cerrar el modal si se hace clic fuera del contenido
    window.onclick = function(event) {
        if (event.target == modal) {
            closeEditModal();
        }
    }
</script>
{% endblock %}